---
metadata:
  name: &name "galera.mdl"
  purpose: "Imagen para nodos de un cluster MariaDB Galera"
  version: "1.0"
  role: "model"
  inheritance:
    - rocky10x.img
  creation_date: "2026-01-25"
  content:
    - "Cluster de base de datos MariaDB"

applications:
  - group: "cluster galera"
    action: "add"
    description: >
      Paquetes para replicación síncrona.
      Incluye motor Galera para cluster MariaDB.
    packages:
      - "galera-4"
      - "mariadb-server-galera"

cluster:
  replication:
    method: "synchronous"
    topology: "multi-master"

  node_identity:
    wsrep_node_name: "placeholder"
    wsrep_node_address: "ip address[:port]"
    description: >
      Cada nodo debe tener nombre único y dirección IP específica.

  state_snapshot_transfer:
    wsrep_sst_method: "mariadb-backup"

  communication:
    cluster_ports:
      - port: 4567
        protocol: "tcp"
        purpose: "cluster_communication"
      - port: 4567
        protocol: "udp"
        purpose: "multicast_replication"
      - port: 4568
        protocol: "tcp"
        purpose: "ist_transfer"
      - port: 4444
        protocol: "tcp"
        purpose: "sst_transfer"

security:
  selinux:
    port_contexts:
      - port: 4567
        protocol: "tcp"
        context_type: "mysqld_port_t"
      - port: 4567
        protocol: "udp"
        context_type: "mysqld_port_t"
      - port: 4568
        protocol: "tcp"
        context_type: "mysqld_port_t"
      - port: 4444
        protocol: "tcp"
        context_type: "mysqld_port_t"

firewall: 
  rules:
    - rule: 1
      name: "cluster communication"
      direction: "input"
      protocol: "tcp"
      port: 4567
    - rule: 2
      name: "multicast replication"
      direction: "input"
      protocol: "udp"
      port: 4567
    - rule: 3
      name: "incremental state transfer"
      direction: "input" #input/output/forward
      protocol: "tcp" #tcp/udp
      port: 4568
    - rule: 4
      name: "snapshot state transfer"
      direction: "input"
      protocol: "tcp"
      port: 4444
---
